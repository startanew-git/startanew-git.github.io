



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="JAVA" href="http://www.startanew.cn/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="JAVA" href="http://www.startanew.cn/atom.xml" />
<link rel="alternate" type="application/json" title="JAVA" href="http://www.startanew.cn/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="other" />


<link rel="canonical" href="http://www.startanew.cn/2021/07/25/k8s%20%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/">



  <title>
k8s 二进制安装 - 运维 |
小小程序员 = JAVA = startanew Blog</title>
<meta name="generator" content="Hexo 5.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="reliefload">
      <span style="--i:0"></span>
      <span style="--i:1"></span>
      <span style="--i:2"></span>
      <span style="--i:3"></span>
      <span style="--i:4"></span>
      <span style="--i:5"></span>
      <span style="--i:6"></span>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">k8s 二进制安装
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2021-07-25 17:09:18">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2021-07-25T17:09:18+08:00">2021-07-25</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>32k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>29 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">小小程序员</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="https://fastly.jsdelivr.net/gh/zjzbury/images@main/essay/u=2746494773,2497161018&fm=26&fmt=auto&gp=0.1w04k0ps919c.webp">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="item" rel="index" title="分类于 运维"><span itemprop="name">运维</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://www.startanew.cn/2021/07/25/k8s%20%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="startanew">
    <meta itemprop="description" content="startanew Blog, 爱编程，爱生活">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="JAVA">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h5 id="集群架构-学习记录"><a class="markdownIt-Anchor" href="#集群架构-学习记录">#</a> 集群架构  (学习记录)</h5>
<blockquote>
<p>两个 master 两个 node<br>
192.168.31.1 etcd<br>
192.168.31.2 master node etcd<br>
192.168.31.3 master node etcd</p>
</blockquote>
<h5 id="基础环境设置"><a class="markdownIt-Anchor" href="#基础环境设置">#</a> 基础环境设置</h5>
<blockquote>
<ol>
<li>设置主机名</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">主机ip:192.168.31.1</span></span><br><span class="line">hostnamectl set-hostname etcd1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">主机ip:192.168.31.2</span></span><br><span class="line">hostnamectl set-hostname k8s2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">主机ip:192.168.31.3</span></span><br><span class="line">hostnamectl set-hostname k8s3</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="2">
<li>关闭防火墙和 selinux</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="3">
<li>设置 yum 源</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo  http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo  http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="4">
<li>常用工具安装</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="5">
<li>安装 cfssl （签发证书使用）</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span><br><span class="line">chmod +x /usr/bin/cfssl*</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="6">
<li>生成根证书</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> mkdir /opt/certs/; cd /opt/certs/</span><br><span class="line"> vim /opt/certs/ca-csr.json</span><br><span class="line"> cat /opt/certs/ca-csr.json</span><br><span class="line"> &#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,  #浏览器使用该字段验证网站是否合法，一般写的是域名</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;, #生成证书的算法</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,  # 国家</span><br><span class="line">            &quot;ST&quot;: &quot;jiangsu&quot;, #州或者是省份</span><br><span class="line">            &quot;L&quot;: &quot;jiangsu&quot;, #地区，城市</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;, #组织名称，公司名称</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot; #组织单位名称，公司部门</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;  # 过期时间（20年）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br><span class="line"></span><br><span class="line"> ls -l ca*</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="7">
<li>安装 docker</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum install -y docker-ce</span><br><span class="line"></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line"><span class="meta">#</span><span class="bash">设置个人镜像仓库</span></span><br><span class="line">&quot;insecure-registries&quot;: [&quot;仓库地址&quot;]</span><br><span class="line"><span class="meta">#</span><span class="bash">  开启docker</span></span><br><span class="line"> systemctl start docker ; systemctl enable docker</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="8">
<li>设置时区</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>
<h5 id="etcd安装"><a class="markdownIt-Anchor" href="#etcd安装">#</a> etcd 安装</h5>
<blockquote>
<p>etcd 地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V0Y2QtaW8vZXRjZC8=">https://github.com/etcd-io/etcd/</span></p>
</blockquote>
<blockquote>
<ol>
<li>创建 ca 的 json 配置</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;175200h&quot;  #过期时间</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">          #表示服务端连接客户端时携带的证书，用于客户端验证服务端身份  server可以自定义</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,    </span><br><span class="line">                    &quot;server auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            #表示客户端连接服务端时携带的证书，用于服务端验证客户端身份 client可以自定义</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            #表示相互之间连接时使用的证书，如etcd节点之间验证</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="2">
<li>创建 etcd 证书配置 (因 etcd 采用集群方式部署，需要 server auth 与 client auth，使用采用 peer 生成证书)</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;192.168.31.1&quot;, #集群的ip列表</span><br><span class="line">        &quot;192.168.31.2&quot;,</span><br><span class="line">        &quot;192.168.31.3&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,  # 国家</span><br><span class="line">            &quot;ST&quot;: &quot;jiangsu&quot;, #州或者是省份</span><br><span class="line">            &quot;L&quot;: &quot;jiangsu&quot;, #地区，城市</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;, #组织名称，公司名称</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot; #组织单位名称，公司部门</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">签发证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span><br><span class="line">ll etcd-peer*</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="3">
<li>安装 etcd</li>
</ol>
</blockquote>
<blockquote>
<p>创建用户</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -M etcd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>下载安装包</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.1.20/etcd-v3.1.20-linux-amd64.tar.gz</span><br><span class="line">tar -xf etcd-v3.1.20-linux-amd64.tar.gz </span><br><span class="line">mv etcd-v3.1.20-linux-amd64 /opt/etcd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将  ca.pem etcd-peer.pem etcd-peer-key.pem  发送到三台机器上  目录 /opt/etcd/certs/</p>
</blockquote>
<blockquote>
<p>创建启动脚本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/etcd/etcd-server-startup.sh</span><br><span class="line">cat /opt/etcd/etcd-server-startup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/opt/etcd/etcd --name etcd-server-31-1 \</span><br><span class="line">    --data-dir /data/etcd/etcd-server \</span><br><span class="line">    --listen-peer-urls https://192.168.31.1:2380 \</span><br><span class="line">    --listen-client-urls https://192.168.31.1:2379,http://127.0.0.1:2379 \</span><br><span class="line">    --quota-backend-bytes 8000000000 \</span><br><span class="line">    --initial-advertise-peer-urls https://192.168.31.1:2380 \</span><br><span class="line">    --advertise-client-urls https://192.168.31.1:2379,http://127.0.0.1:2379 \</span><br><span class="line">    --initial-cluster  etcd-server-31-1=https://192.168.31.1:2380,etcd-server-31-2=https://192.168.31.2:2380,etcd-server-31-3=https://192.168.31.3:2380 \</span><br><span class="line">    --ca-file ./certs/ca.pem \</span><br><span class="line">    --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">    --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">    --client-cert-auth  \</span><br><span class="line">    --trusted-ca-file ./certs/ca.pem \</span><br><span class="line">    --peer-ca-file ./certs/ca.pem \</span><br><span class="line">    --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">    --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">    --peer-client-cert-auth \</span><br><span class="line">    --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">    --log-output stdout</span><br><span class="line"><span class="meta">#</span><span class="bash">给予运行权限</span></span><br><span class="line">chmod u+x /opt/etcd/etcd-server-startup.sh</span><br><span class="line">chown -R etcd.etcd /opt/etcd/ /data/etcd /data/logs/etcd-server</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="4">
<li>启动 etcd</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用supervisor启动脚本</span></span><br><span class="line"><span class="meta">#</span><span class="bash">安装</span></span><br><span class="line">yum install -y supervisor</span><br><span class="line">systemctl start supervisord ; systemctl enable supervisord</span><br><span class="line"><span class="meta">#</span><span class="bash">编写启动脚本配置文件</span></span><br><span class="line">vim /etc/supervisord.d/etcd-server.ini</span><br><span class="line">cat /etc/supervisord.d/etcd-server.ini</span><br><span class="line">[program:etcd-server-31-1]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh              ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                            ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/etcd                                   ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                        ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                      ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                          ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                        ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                         ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                       ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                       ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=etcd                                             ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                  ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                          ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=5                              ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                           ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                           ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件更新后，使用supervisorctl update,使配置生效</span></span><br><span class="line">supervisorctl status  # supervisorctl 状态</span><br><span class="line">supervisorctl start  xxx  # 运行某个脚本</span><br><span class="line">supervisorctl stop  xxx  # 停止运行某个脚本</span><br><span class="line">supervisorctl restart  xxx  # 重新运行某个脚本</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="5">
<li>其他两台跟第一台一样安装， 只需要修改 ip 地址</li>
</ol>
</blockquote>
<blockquote>
<p>查看集群</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd/etcdctl member list</span><br><span class="line"></span><br><span class="line">/opt/etcd/etcdctl cluster-health</span><br></pre></td></tr></table></figure>
<h5 id="安装apiserver"><a class="markdownIt-Anchor" href="#安装apiserver">#</a> 安装 apiserver</h5>
<blockquote>
<ol>
<li>下载安装包</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">下载地址:https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz </span><br><span class="line">mv kubernetes /opt/kubernetes</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="2">
<li>签发证书</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 签发 apiserver和etcd通信证书  客户端证书</span></span><br><span class="line">vim /opt/certs/client-csr.json</span><br><span class="line">cat /opt/certs/client-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,  # 国家</span><br><span class="line">            &quot;ST&quot;: &quot;jiangsu&quot;, #州或者是省份</span><br><span class="line">            &quot;L&quot;: &quot;jiangsu&quot;, #地区，城市</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;, #组织名称，公司名称</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot; #组织单位名称，公司部门</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="3">
<li>签发 server 证书（apiserver 和其它 k8s 组件通信使用）</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> vim /opt/certs/apiserver-csr.json</span><br><span class="line"> cat /opt/certs/apiserver-csr.json</span><br><span class="line"> &#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-apiserver&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.0.1&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;,</span><br><span class="line">        &quot;192.168.31.2&quot;,  #所有apiserver ip</span><br><span class="line">        &quot;192.168.31.3&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,  # 国家</span><br><span class="line">            &quot;ST&quot;: &quot;jiangsu&quot;, #州或者是省份</span><br><span class="line">            &quot;L&quot;: &quot;jiangsu&quot;, #地区，城市</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;, #组织名称，公司名称</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot; #组织单位名称，公司部门</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">签发证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将apiserver-key.pem apiserver.pem ca-key.pem ca.pem client-key.pem client.pem 复制到每个apiserver主机的/opt/kubernetes/server/bin/certs/目录</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>4. 配置 apiserver 日志审计</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/kubernetes/conf</span><br><span class="line">vim /opt/kubernetes/conf/audit.yaml </span><br><span class="line">cat /opt/kubernetes/conf/audit.yaml </span><br><span class="line">apiVersion: audit.k8s.io/v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"><span class="meta">#</span><span class="bash"> Don<span class="string">&#x27;t generate audit events for all requests in RequestReceived stage.</span></span></span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Log pod changes at RequestResponse level</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      # Resource &quot;pods&quot; doesn&#x27;t match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: [&quot;pods&quot;]</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Log <span class="string">&quot;pods/log&quot;</span>, <span class="string">&quot;pods/status&quot;</span> at Metadata level</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;pods/log&quot;, &quot;pods/status&quot;]</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">&#x27;t log requests to a configmap called &quot;controller-leader&quot;</span></span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">      resourceNames: [&quot;controller-leader&quot;]</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">&#x27;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span></span></span><br><span class="line">  - level: None</span><br><span class="line">    users: [&quot;system:kube-proxy&quot;]</span><br><span class="line">    verbs: [&quot;watch&quot;]</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;endpoints&quot;, &quot;services&quot;]</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">&#x27;t log authenticated requests to certain non-resource URL paths.</span></span></span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [&quot;system:authenticated&quot;]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - &quot;/api*&quot; # Wildcard matching.</span><br><span class="line">    - &quot;/version&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Log the request body of configmap changes <span class="keyword">in</span> kube-system.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">    # This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br><span class="line">    # The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: [&quot;kube-system&quot;]</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Log configmap and secret changes <span class="keyword">in</span> all other namespaces at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Log all other resources <span class="keyword">in</span> core and extensions at the Request level.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">    - group: &quot;extensions&quot; # Version of group should NOT be included.</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> A catch-all rule to <span class="built_in">log</span> all other requests at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="5">
<li>配置启动脚本</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vim /opt/kubernetes/server/bin/kube-apiserver-startup.sh</span><br><span class="line">cat /opt/kubernetes/server/bin/kube-apiserver-startup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">/opt/kubernetes/server/bin/kube-apiserver \</span><br><span class="line">    --apiserver-count 2 \   #集群中运行的apiserver的数量</span><br><span class="line">    --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \</span><br><span class="line">    --audit-policy-file ../../conf/audit.yaml \</span><br><span class="line">    --authorization-mode RBAC \</span><br><span class="line">    --client-ca-file ./certs/ca.pem \</span><br><span class="line">    --requestheader-client-ca-file ./certs/ca.pem \</span><br><span class="line">    --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">    --etcd-cafile ./certs/ca.pem \</span><br><span class="line">    --etcd-certfile ./certs/client.pem \</span><br><span class="line">    --etcd-keyfile ./certs/client-key.pem \</span><br><span class="line">    --etcd-servers https://192.168.31.1:2379,https://192.168.31.2:2379,https://192.168.31.3:2379 \</span><br><span class="line">    --service-account-key-file ./certs/ca-key.pem \</span><br><span class="line">    --service-cluster-ip-range 192.168.0.0/16 \    #server内部网段</span><br><span class="line">    --service-node-port-range 3000-29999 \         # 对外暴露端口范围   默认30000-32767</span><br><span class="line">    --target-ram-mb=1024 \</span><br><span class="line">    --kubelet-client-certificate ./certs/client.pem \</span><br><span class="line">    --kubelet-client-key ./certs/client-key.pem \</span><br><span class="line">    --log-dir  /data/logs/kubernetes/kube-apiserver \</span><br><span class="line">    --tls-cert-file ./certs/apiserver.pem \</span><br><span class="line">    --tls-private-key-file ./certs/apiserver-key.pem \</span><br><span class="line">    --v 2</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="6">
<li>配置 supervisor 启动配置</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/supervisord.d/kube-apiserver.ini</span><br><span class="line">cat /etc/supervisord.d/kube-apiserver.ini</span><br><span class="line">[program:kube-apiserver-31.2]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-apiserver-startup.sh</span><br><span class="line">numprocs=1</span><br><span class="line">directory=/opt/kubernetes/server/bin</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=30</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=QUIT</span><br><span class="line">stopwaitsecs=10</span><br><span class="line">user=root</span><br><span class="line">redirect_stderr=true</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log</span><br><span class="line">stdout_logfile_maxbytes=64MB</span><br><span class="line">stdout_logfile_backups=5</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_events_enabled=false</span><br><span class="line"><span class="meta">#</span><span class="bash">注意 logfile目录要手动创建 不然启动不了</span></span><br><span class="line">mkdir -p /data/logs/kubernetes/kube-apiserver/  </span><br><span class="line">supervisorctl update</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="7">
<li>在 192.168.31.2 上面安装 nginx 做 apiserver 负载均衡 (证书里面必须包含 nginx 主机 ip)</li>
</ol>
</blockquote>
<blockquote>
<p>配置如下</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 192.168.31.2:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.31.3:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">        access_log /var/log/nginx/proxy.log proxy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="安装controller-manager"><a class="markdownIt-Anchor" href="#安装controller-manager">#</a> 安装 controller-manager</h5>
<blockquote>
<p>1. 配置启动脚本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/kubernetes/server/bin/kube-controller-manager-startup.sh</span><br><span class="line">cat /opt/kubernetes/server/bin/kube-controller-manager-startup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">/opt/kubernetes/server/bin/kube-controller-manager \</span><br><span class="line">    --cluster-cidr 172.7.0.0/16 \    #pod网段</span><br><span class="line">    --leader-elect true \</span><br><span class="line">    --log-dir /data/logs/kubernetes/kube-controller-manager \</span><br><span class="line">    --master http://127.0.0.1:8080 \</span><br><span class="line">    --service-account-private-key-file ./certs/ca-key.pem \</span><br><span class="line">    --service-cluster-ip-range 192.168.0.0/16 \  #server网段</span><br><span class="line">    --root-ca-file ./certs/ca.pem \</span><br><span class="line">    --v 2</span><br><span class="line"><span class="meta">#</span><span class="bash">运行权限</span>    </span><br><span class="line">chmod u+x /opt/kubernetes/server/bin/kube-controller-manager-startup.sh</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="2">
<li>配置 supervisor 启动配置</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/supervisord.d/kube-controller-manager.ini</span><br><span class="line">cat /etc/supervisord.d/kube-controller-manager.ini</span><br><span class="line">[program:kube-controller-manager-31-2]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-controller-manager-startup.sh             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                                     ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                                       ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                                                       ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">supervisorctl update</span><br></pre></td></tr></table></figure>
<h5 id="安装kube-scheduler"><a class="markdownIt-Anchor" href="#安装kube-scheduler">#</a> 安装 kube-scheduler</h5>
<blockquote>
<ol>
<li>创建启动脚本</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/kubernetes/server/bin/kube-scheduler-startup.sh</span><br><span class="line">cat /opt/kubernetes/server/bin/kube-scheduler-startup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">/opt/kubernetes/server/bin/kube-scheduler \</span><br><span class="line">    --leader-elect  \</span><br><span class="line">    --log-dir /data/logs/kubernetes/kube-scheduler \</span><br><span class="line">    --master http://127.0.0.1:8080 \</span><br><span class="line">    --v 2</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash">运行权限</span></span><br><span class="line"> chmod u+x /opt/kubernetes/server/bin/kube-scheduler-startup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">log</span> 目录</span></span><br><span class="line">mkdir -p /data/logs/kubernetes/kube-scheduler</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="2">
<li>配置 supervisor 启动配置</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/supervisord.d/kube-scheduler.ini</span><br><span class="line">cat /etc/supervisord.d/kube-scheduler.ini</span><br><span class="line"></span><br><span class="line">[program:kube-scheduler-31-2]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-scheduler-startup.sh                     </span><br><span class="line">numprocs=1                                                               </span><br><span class="line">directory=/opt/kubernetes/server/bin                                     </span><br><span class="line">autostart=true                                                           </span><br><span class="line">autorestart=true                                                         </span><br><span class="line">startsecs=30                                                             </span><br><span class="line">startretries=3                                                           </span><br><span class="line">exitcodes=0,2                                                            </span><br><span class="line">stopsignal=QUIT                                                          </span><br><span class="line">stopwaitsecs=10                                                          </span><br><span class="line">user=root                                                                </span><br><span class="line">redirect_stderr=true                                                     </span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log </span><br><span class="line">stdout_logfile_maxbytes=64MB                                             </span><br><span class="line">stdout_logfile_backups=4                                                 </span><br><span class="line">stdout_capture_maxbytes=1MB                                              </span><br><span class="line">stdout_events_enabled=false </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建<span class="built_in">log</span>目录</span></span><br><span class="line">mkdir  -p /data/logs/kubernetes/kube-scheduler/</span><br><span class="line">supervisorctl update</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="3">
<li>查看主控节点状态</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br></pre></td></tr></table></figure>
<h5 id="kubelet-部署"><a class="markdownIt-Anchor" href="#kubelet-部署">#</a> kubelet 部署</h5>
<blockquote>
<ol>
<li>签发证书</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim kubelet-csr.json </span><br><span class="line">cat kubelet-csr.json </span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-kubelet&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;192.168.31.2&quot;, #所有安装kubelet的主机ip</span><br><span class="line">    &quot;192.168.31.3&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,  # 国家</span><br><span class="line">            &quot;ST&quot;: &quot;jiangsu&quot;, #州或者是省份</span><br><span class="line">            &quot;L&quot;: &quot;jiangsu&quot;, #地区，城市</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;, #组织名称，公司名称</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot; #组织单位名称，公司部门</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">签发证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet</span><br><span class="line">将证书ca.pem kubelet.pem kubelet-key.pem复制到安装kubelet主机的/opt/kubernetes/server/bin/certs/目录 </span><br></pre></td></tr></table></figure>
<blockquote>
<p>2. 创建 kubelet 配置</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">set-cluster  # 创建需要连接的集群信息，可以创建多个k8s集群信息</span><br><span class="line">kubectl config set-cluster myk8s \</span><br><span class="line">--certificate-authority=/opt/kubernetes/server/bin/certs/ca.pem \  </span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.31.2:7443 \   #nginx负载api-server的主机</span><br><span class="line">--kubeconfig=/opt/kubernetes/conf/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">set-credentials  # 创建用户账号，即用户登陆使用的客户端私有和证书，可以创建多个证书</span><br><span class="line"> kubectl kubectl config set-credentials k8s-node \</span><br><span class="line">--client-certificate=/opt/kubernetes/server/bin/certs/client.pem \</span><br><span class="line">--client-key=/opt/kubernetes/server/bin/certs/client-key.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=/opt/kubernetes/conf/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">set-context  # 设置context，即确定账号和集群对应关</span><br><span class="line">kubectl config set-context myk8s-context \</span><br><span class="line">--cluster=myk8s \</span><br><span class="line">--user=k8s-node \</span><br><span class="line">--kubeconfig=/opt/kubernetes/conf/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">use-context  # 设置当前使用哪个context</span><br><span class="line">kubectl config use-context myk8s-context --kubeconfig=/opt/kubernetes/conf/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将kubelet.kubeconfig传给另一台就不用做以上四步  目录/opt/kubernetes/conf/</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="3">
<li>授权 k8s-node 用户</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只需要在一台master节点执行</span></span><br><span class="line">vim k8s-node.yaml</span><br><span class="line">cat  k8s-node.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create -f k8s-node.yaml</span><br><span class="line">kubectl get clusterrolebinding k8s-node</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="4">
<li>装备 pause 镜像</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker image pull kubernetes/pause</span><br><span class="line">docker image tag kubernetes/pause:latest 个人镜像地址/public/pause:latest</span><br><span class="line">docker login -u admin 个人镜像地址</span><br><span class="line">docker image push 个人镜像地址/public/pause:latest</span><br></pre></td></tr></table></figure>
<blockquote>
<p>5. 创建启动脚本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"> vim /opt/kubernetes/server/bin/kubelet-startup.sh</span><br><span class="line"> cat /opt/kubernetes/server/bin/kubelet-startup.sh</span><br><span class="line"> </span><br><span class="line"><span class="meta"> #</span><span class="bash">!/bin/sh</span></span><br><span class="line"> /opt/kubernetes/server/bin/kubelet \</span><br><span class="line">    --anonymous-auth=false \</span><br><span class="line">    --cgroup-driver systemd \</span><br><span class="line">    --cluster-dns 192.168.0.2 \</span><br><span class="line">    --cluster-domain cluster.local \</span><br><span class="line">    --runtime-cgroups=/systemd/system.slice \</span><br><span class="line">    --kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">    --fail-swap-on=&quot;false&quot; \</span><br><span class="line">    --client-ca-file ./certs/ca.pem \</span><br><span class="line">    --tls-cert-file ./certs/kubelet.pem \</span><br><span class="line">    --tls-private-key-file ./certs/kubelet-key.pem \</span><br><span class="line">    --hostname-override 主机名称 \</span><br><span class="line">    --image-gc-high-threshold 20 \</span><br><span class="line">    --image-gc-low-threshold 10 \</span><br><span class="line">    --kubeconfig ../../conf/kubelet.kubeconfig \</span><br><span class="line">    --log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">    --pod-infra-container-image 个人镜像地址/public/pause:latest \</span><br><span class="line">    --root-dir /data/kubelet</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">chmod u+x /opt/kubernetes/server/bin/kubelet-startup.sh</span><br><span class="line">mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim /etc/supervisord.d/kube-kubelet.ini</span><br><span class="line">cat /etc/supervisord.d/kube-kubelet.ini</span><br><span class="line"></span><br><span class="line">[program:kube-kubelet-31-2]</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet-startup.sh</span><br><span class="line">numprocs=1</span><br><span class="line">directory=/opt/kubernetes/server/bin</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=30</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=QUIT</span><br><span class="line">stopwaitsecs=10</span><br><span class="line">user=root</span><br><span class="line">redirect_stderr=true</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log</span><br><span class="line">stdout_logfile_maxbytes=64MB</span><br><span class="line">stdout_logfile_backups=5</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_events_enabled=false</span><br><span class="line"></span><br><span class="line">supervisorctl update</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看node</span></span><br><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="6">
<li>修改节点角色</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl label node 31.2.com node-role.kubernetes.io/node     # node角色</span><br><span class="line">kubectl label node 31.2.com node-role.kubernetes.io/master=  #master角色</span><br><span class="line">kubectl label node 31.3.com node-role.kubernetes.io/node</span><br><span class="line">kubectl label node 31.3.com node-role.kubernetes.io/master=</span><br></pre></td></tr></table></figure>
<h5 id="kube-proxy部署"><a class="markdownIt-Anchor" href="#kube-proxy部署">#</a> kube-proxy 部署</h5>
<blockquote>
<ol>
<li>签发证书</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim kube-proxy-csr.json</span><br><span class="line">cat kube-proxy-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,  # 国家</span><br><span class="line">            &quot;ST&quot;: &quot;jiangsu&quot;, #州或者是省份</span><br><span class="line">            &quot;L&quot;: &quot;jiangsu&quot;, #地区，城市</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;, #组织名称，公司名称</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot; #组织单位名称，公司部门</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span><br><span class="line"><span class="meta">#</span><span class="bash">将 kube-proxy-client-key.pem kube-proxy-client.pem  复制到31.2 与31.3主机   /opt/kubernetes/server/bin/certs/</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="2">
<li>创建 kube-proxy 配置</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster myk8s \</span><br><span class="line">--certificate-authority=/opt/kubernetes/server/bin/certs/ca.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.31.2:7443 \</span><br><span class="line">--kubeconfig=/opt/kubernetes/conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">--client-certificate=/opt/kubernetes/server/bin/certs/kube-proxy-client.pem \</span><br><span class="line">--client-key=/opt/kubernetes/server/bin/certs/kube-proxy-client-key.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=/opt/kubernetes/conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-context myk8s-context \</span><br><span class="line">--cluster=myk8s \</span><br><span class="line">--user=kube-proxy \</span><br><span class="line">--kubeconfig=/opt/kubernetes/conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context myk8s-context --kubeconfig=/opt/kubernetes/conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 把kube-proxy.kubeconfig传到另一台机器 ,那边就可以不用做以上四步</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="3">
<li>加载 ipvs 模块</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in $(ls /usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs|grep -o &quot;^[^.]*&quot;);do echo $i; /sbin/modinfo -F filename $i &gt;/dev/null 2&gt;&amp;1 &amp;&amp; /sbin/modprobe $i;done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看ipvs模块</span></span><br><span class="line">lsmod | grep ip_vs  </span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="4">
<li>创建启动脚本</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/kubernetes/server/bin/kube-proxy-startup.sh</span><br><span class="line">cat /opt/kubernetes/server/bin/kube-proxy-startup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">/opt/kubernetes/server/bin/kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \   # pod网段</span><br><span class="line">  --hostname-override 主机名称 \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-scheduler=nq \</span><br><span class="line">  --kubeconfig ../../conf/kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> chmod u+x  /opt/kubernetes-v1.15.2/server/bin/kube-proxy-startup.sh</span><br><span class="line"> mkdir -p /data/logs/kubernetes/kube-proxy</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> vim /etc/supervisord.d/kube-proxy.ini</span><br><span class="line"> cat /etc/supervisord.d/kube-proxy.ini</span><br><span class="line">[program:kube-proxy-31-2]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-proxy-startup.sh                </span><br><span class="line">numprocs=1                                                      </span><br><span class="line">directory=/opt/kubernetes/server/bin                            </span><br><span class="line">autostart=true                                                  </span><br><span class="line">autorestart=true                                                </span><br><span class="line">startsecs=30                                                    </span><br><span class="line">startretries=3                                                  </span><br><span class="line">exitcodes=0,2                                                   </span><br><span class="line">stopsignal=QUIT                                                 </span><br><span class="line">stopwaitsecs=10                                                 </span><br><span class="line">user=root                                                       </span><br><span class="line">redirect_stderr=true                                            </span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    </span><br><span class="line">stdout_logfile_backups=5                                       </span><br><span class="line">stdout_capture_maxbytes=1MB                                     </span><br><span class="line">stdout_events_enabled=false</span><br><span class="line"></span><br><span class="line">supervisorctl update</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>5. 验证集群</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc</span><br><span class="line"></span><br><span class="line">vi nginx-test.yaml</span><br><span class="line">cat nginx-test.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">    name: nginx-test</span><br><span class="line">spec:</span><br><span class="line">    template:</span><br><span class="line">      metadata:</span><br><span class="line">        labels:</span><br><span class="line">          app: nginx-test</span><br><span class="line">      spec:</span><br><span class="line">        containers:</span><br><span class="line">        - name: my-nginx</span><br><span class="line">          image: 个人镜像地址/public/nginx:v1.7.9</span><br><span class="line">          ports:</span><br><span class="line">          - containerPort: 80  </span><br><span class="line"></span><br><span class="line"> kubectl create -f  nginx-test.yaml</span><br><span class="line"> </span><br><span class="line"> kubectl get pods</span><br><span class="line"> </span><br><span class="line"> kubectl get pods -o  wide 获取详情信息</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="安装flannel使pod可以跨主机通信"><a class="markdownIt-Anchor" href="#安装flannel使pod可以跨主机通信">#</a> 安装 flannel 使 pod 可以跨主机通信</h5>
<blockquote>
<ol>
<li>下载</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget &quot;https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz&quot;</span><br><span class="line">tar xf flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel</span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="2">
<li>拷贝 ca.pem  ca.pem client-key.pem 证书到 /opt/flannel/cert</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li>配置文件 &amp; 启动脚本</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> vi flanneld.sh</span><br><span class="line"> cat flanneld.sh</span><br><span class="line"> </span><br><span class="line"><span class="meta"> #</span><span class="bash">!/bin/sh</span></span><br><span class="line">./flanneld </span><br><span class="line">  --public-ip=192.168.31.2 \</span><br><span class="line">  --etcd-endpoints=https://192.168.31.1:2379,https://192.168.31.2:2379,https://192.168.31.3:2379 \ </span><br><span class="line">  --etcd-keyfile=./cert/client-key.pem </span><br><span class="line">  --etcd-certfile=./cert/client.pem </span><br><span class="line">  --etcd-cafile=./cert/ca.pem </span><br><span class="line">  --iface=eth0 \  #网卡</span><br><span class="line">  --healthz-port=2401</span><br><span class="line">  </span><br><span class="line">chmod u+x flanneld.sh</span><br><span class="line">   </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>4. 设置 vxlan 模型</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">etcdctl ls coreos.com/network/config/</span><br><span class="line">etcdctl rm /coreos.com/network/config</span><br><span class="line"></span><br><span class="line">etcdctl ls coreos.com/network/subnets/</span><br><span class="line"></span><br><span class="line">etcdctl rm /coreos.com/network/subnets/172.7.30.0-24</span><br><span class="line">etcdctl rm /coreos.com/network/subnets/172.7.40.0-24</span><br><span class="line"></span><br><span class="line">etcdctl set /coreos.com/network/config &#x27;&#123;&quot;Network&quot;: &quot;172.7.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;VxLAN&quot;&#125;&#125;&#x27;</span><br><span class="line">etcdctl get /coreos.com/network/config</span><br></pre></td></tr></table></figure>
<blockquote>
<p>5. 启动 flannel</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/supervisord.d/flannel.ini</span><br><span class="line">cat /etc/supervisord.d/flannel.ini</span><br><span class="line"></span><br><span class="line">[program:flanneld-31-2]</span><br><span class="line">command=/opt/flannel/flanneld.sh                             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                   ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/flannel                                       ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                               ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                             ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                 ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                               ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                ; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                              ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                              ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                    ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                         ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/flanneld/flanneld.stdout.log       ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                     ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                  ; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="line">stdout_events_enabled=false                                  ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p /data/logs/flanneld/</span><br><span class="line"></span><br><span class="line">supervisorctl update</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看路由</span></span><br><span class="line">route -n</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<ol start="6">
<li>docker 设置 flannel 网络</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> flannel网段</span></span><br><span class="line">&quot;bip&quot;: &quot;172.7.40.1/24&quot;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启dockers</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="部署ingress-nginx使外部网络可以访问"><a class="markdownIt-Anchor" href="#部署ingress-nginx使外部网络可以访问">#</a> 部署 ingress-nginx 使外部网络可以访问</h5>
<blockquote>
<p>地址:<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMvaW5ncmVzcy1uZ2lueA==">https://github.com/kubernetes/ingress-nginx</span></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat mandatory.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash">--------------------- namespaces -----------------------<span class="comment">#</span></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash">--------------------- ConfigMap--------------------------<span class="comment">#</span></span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: ingress-nginx</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-load-balancer-conf</span><br><span class="line">data:</span><br><span class="line">  enable-vts-status: &quot;true&quot;</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------rbac--------------------------<span class="comment">#</span></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - endpoints</span><br><span class="line">      - nodes</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;extensions&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">        - events</span><br><span class="line">    verbs:</span><br><span class="line">        - create</span><br><span class="line">        - patch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;extensions&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">      - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    resourceNames:</span><br><span class="line">      # Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span><br><span class="line">      # Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span><br><span class="line">      # This has to be adapted if you change either parameter</span><br><span class="line">      # when launching the nginx-ingress-controller.</span><br><span class="line">      - &quot;ingress-controller-leader-nginx&quot;</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - endpoints</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------nginx-controller-----------------<span class="comment">#</span></span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: &#x27;10254&#x27;</span><br><span class="line">        prometheus.io/scrape: &#x27;true&#x27;</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-ingress-controller</span><br><span class="line">          image: 个人镜像地址/public/nginx-ingress-controller:0.20.0</span><br><span class="line">          args:</span><br><span class="line">            - /nginx-ingress-controller</span><br><span class="line">            - --default-backend-service=$(POD_NAMESPACE)/default-http-backend</span><br><span class="line">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">            - --publish-service=$(POD_NAMESPACE)/nginx-ingress-controller</span><br><span class="line">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">          env:</span><br><span class="line">            - name: POD_NAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            - name: POD_NAMESPACE</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 80</span><br><span class="line">          - name: https</span><br><span class="line">            containerPort: 443</span><br><span class="line">          - containerPort: 8080</span><br><span class="line">            hostPort: 8080</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          securityContext:</span><br><span class="line">            runAsNonRoot: false</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    name: http</span><br><span class="line">  - port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 443</span><br><span class="line">    name: https</span><br><span class="line">  - port: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">    name: nginx-status</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: nginx-ingress-controller</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-status-ingress</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: nginx-ui.local</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-ingress-controller</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="meta">#</span><span class="bash">-----------------------default-http-backend--------------<span class="comment">#</span></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - name: default-http-backend</span><br><span class="line">        # Any image is permissable as long as:</span><br><span class="line">        # 1. It serves a 404 page at /</span><br><span class="line">        # 2. It serves 200 on a /healthz endpoint</span><br><span class="line">        image: 个人镜像地址/public/defaultbackend-amd64:1.5   </span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create -f  mandatory.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pod -o wide -n ingress-nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">部署nginx</span></span><br><span class="line">kubectl create -f  nginx-test.yaml</span><br><span class="line">cat nginx-test.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">    name: nginx-test</span><br><span class="line">spec:</span><br><span class="line">    template:</span><br><span class="line">      metadata:</span><br><span class="line">        labels:</span><br><span class="line">          app: nginx-test</span><br><span class="line">      spec:</span><br><span class="line">        containers:</span><br><span class="line">        - name: my-nginx</span><br><span class="line">          image: 个人镜像地址/public/nginx:v1.7.9</span><br><span class="line">          ports:</span><br><span class="line">          - containerPort: 80  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建nginx-svc</span> </span><br><span class="line">cat nginx-svc.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-test</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line"></span><br><span class="line">kubectl create -f  nginx-svc.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">对外暴露端口</span></span><br><span class="line">cat   test-nginx-ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">spec:</span><br><span class="line"><span class="meta">#</span><span class="bash">   tls:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     - secretName: test-nginx</span></span><br><span class="line">  rules:</span><br><span class="line">  - host: 域名</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-svc</span><br><span class="line">          servicePort: 80</span><br><span class="line"></span><br><span class="line">kubectl create -f  test-nginx-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看部署情况</span></span><br><span class="line">kubectl get ing</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">通过域名即可访问nginx</span></span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/other/" rel="tag"><i class="ic i-tag"></i> other</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2022-05-21 17:39:24" itemprop="dateModified" datetime="2022-05-21T17:39:24+08:00">2022-05-21</time>
  </span>
  <span id="2021/07/25/k8s  二进制安装/" class="item leancloud_visitors" data-flag-title="k8s 二进制安装" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="startanew 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="startanew 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="startanew 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>startanew <i class="ic i-at"><em>@</em></i>JAVA
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://www.startanew.cn/2021/07/25/k8s%20%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/" title="k8s 二进制安装">http://www.startanew.cn/2021/07/25/k8s  二进制安装/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2021/07/25/%E5%AE%89%E8%A3%85harbor/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;fastly.jsdelivr.net&#x2F;gh&#x2F;zjzbury&#x2F;images@main&#x2F;essay&#x2F;捕获.4mygeo8pyl20.PNG" title="安装harbor">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>安装harbor</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2021/07/25/k8s%20%20kubeadmin%E5%AE%89%E8%A3%85/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;fastly.jsdelivr.net&#x2F;gh&#x2F;zjzbury&#x2F;images@main&#x2F;essay&#x2F;u&#x3D;2746494773,2497161018&amp;fm&#x3D;26&amp;fmt&#x3D;auto&amp;gp&#x3D;0.1w04k0ps919c.webp" title="k8s kubeadmin安装">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>k8s kubeadmin安装</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84-%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text"> 集群架构  (学习记录)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text"> 基础环境设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#etcd%E5%AE%89%E8%A3%85"><span class="toc-number">3.</span> <span class="toc-text"> etcd 安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85apiserver"><span class="toc-number">4.</span> <span class="toc-text"> 安装 apiserver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85controller-manager"><span class="toc-number">5.</span> <span class="toc-text"> 安装 controller-manager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kube-scheduler"><span class="toc-number">6.</span> <span class="toc-text"> 安装 kube-scheduler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kubelet-%E9%83%A8%E7%BD%B2"><span class="toc-number">7.</span> <span class="toc-text"> kubelet 部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kube-proxy%E9%83%A8%E7%BD%B2"><span class="toc-number">8.</span> <span class="toc-text"> kube-proxy 部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85flannel%E4%BD%BFpod%E5%8F%AF%E4%BB%A5%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1"><span class="toc-number">9.</span> <span class="toc-text"> 安装 flannel 使 pod 可以跨主机通信</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2ingress-nginx%E4%BD%BF%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE"><span class="toc-number">10.</span> <span class="toc-text"> 部署 ingress-nginx 使外部网络可以访问</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/2021/07/25/%E8%87%AA%E5%BB%BAdns/" rel="bookmark" title="自建dns">自建dns</a></li><li><a href="/2021/07/25/k8s%20%20kubeadmin%E5%AE%89%E8%A3%85/" rel="bookmark" title="k8s kubeadmin安装">k8s kubeadmin安装</a></li><li class="active"><a href="/2021/07/25/k8s%20%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/" rel="bookmark" title="k8s 二进制安装">k8s 二进制安装</a></li><li><a href="/2021/07/25/%E5%AE%89%E8%A3%85harbor/" rel="bookmark" title="安装harbor">安装harbor</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="startanew"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">startanew</p>
  <div class="description" itemprop="description">爱编程，爱生活</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">89</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">7</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">23</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3N0YXJ0YW5ldy1naXQ=" title="https:&#x2F;&#x2F;github.com&#x2F;startanew-git"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEzMDczMjU3OTM=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1307325793"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOnpqenN0YXJ0YW5ld0AxNjNjb20=" title="mailto:zjzstartanew@163com"><i class="ic i-envelope"></i></span>
      <span class="exturl item douban" data-url="aHR0cHM6Ly93d3cuZG91YmFuLmNvbS9wZW9wbGUvMjIzOTg5NzEyLw==" title="https:&#x2F;&#x2F;www.douban.com&#x2F;people&#x2F;223989712&#x2F;"><i class="ic i-douban"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-clipboard"></i>其他</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/tool/" rel="section"><i class="ic i-magic"></i>收藏</a>
  </li>

        
  <li class="item">
    <a href="/resources/" rel="section"><i class="ic i-cloud-music"></i>资源</a>
  </li>

        
  <li class="item">
    <a href="/images/" rel="section"><i class="ic i-heart"></i>图片</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2021/07/25/%E5%AE%89%E8%A3%85harbor/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2021/07/25/k8s%20%20kubeadmin%E5%AE%89%E8%A3%85/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/programming/" title="分类于 编程">编程</a>
</div>

    <span><a href="/2020/07/13/ssm%E6%95%B4%E5%90%88sceurity-%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95%E4%B9%8Bsceurity%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D/" title="ssm整合sceurity-基础用法之sceurity基本配置介绍">ssm整合sceurity-基础用法之sceurity基本配置介绍</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/programming/" title="分类于 编程">编程</a>
</div>

    <span><a href="/2020/10/15/java-%E6%B1%89%E5%AD%97%E8%BD%AC%E6%8B%BC%E9%9F%B3/" title="java 汉字转拼音">java 汉字转拼音</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/programming/" title="分类于 编程">编程</a>
</div>

    <span><a href="/2021/04/01/java-Jni/" title="Jni">Jni</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/programming/" title="分类于 编程">编程</a>
</div>

    <span><a href="/2021/06/05/video-js-%E4%BD%BF%E7%94%A8/" title="video.js 使用">video.js 使用</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/programming/" title="分类于 编程">编程</a>
</div>

    <span><a href="/2020/07/13/ssm%E6%95%B4%E5%90%88sceurity-%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95%E4%B9%8Bsceurity%E7%BB%93%E5%90%88%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8A%A8%E6%80%81%E9%89%B4%E6%9D%83/" title="ssm整合sceurity-基础用法之sceurity结合数据库动态鉴权">ssm整合sceurity-基础用法之sceurity结合数据库动态鉴权</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/HumanResourceManagement/" title="分类于 人力资源管理">人力资源管理</a>
</div>

    <span><a href="/2020/10/08/%E5%91%98%E5%B7%A5%E5%85%B3%E7%B3%BB%E7%AE%A1%E7%90%86%E6%A6%82%E8%AE%BA/" title="第一章 员工关系管理概论">第一章 员工关系管理概论</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/HumanResourceManagement/" title="分类于 人力资源管理">人力资源管理</a>
</div>

    <span><a href="/2020/10/08/%E5%B7%A5%E4%BD%9C%E8%AE%BE%E8%AE%A1/" title="第八章 工作设计">第八章 工作设计</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/programming/" title="分类于 编程">编程</a>
</div>

    <span><a href="/2021/06/05/pdf%E8%BD%AC%E5%9B%BE%E7%89%87/" title="pdf转图片">pdf转图片</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/programming/" title="分类于 编程">编程</a>
</div>

    <span><a href="/2021/11/27/%E6%8E%A5%E5%85%A5%E6%94%AF%E4%BB%98%E5%AE%9D%E4%B8%8E%E5%BE%AE%E4%BF%A1(%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83)/" title="接入支付宝与微信(沙箱环境)">接入支付宝与微信(沙箱环境)</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" title="分类于 内网穿透">内网穿透</a>
</div>

    <span><a href="/2021/04/17/%E5%AE%89%E8%A3%85tinc%E7%BB%84%E5%BB%BA%E4%BB%A5%E5%A4%AA%E7%BD%91/" title="安装tinc组建以太网">安装tinc组建以太网</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">startanew @ 小小程序员</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">288k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">4:22</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2021/07/25/k8s  二进制安装/',
    favicon: {
      show: "（●´3｀●）",
      hide: "(´Д｀)"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
